<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OAuth Debug Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      cursor: pointer;
      margin: 10px;
    }
    #log {
      background: #000;
      padding: 20px;
      border: 2px solid #0f0;
      margin-top: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
  </style>
</head>
<body>
  <h1>🔧 OAuth Diagnostic Tool</h1>
  <p>This will test each step of the OAuth flow separately</p>
  
  <button onclick="testStep1()">Step 1: Check gapi loaded</button>
  <button onclick="testStep2()">Step 2: Load client:auth2</button>
  <button onclick="testStep3()">Step 3: Initialize gapi.client</button>
  <button onclick="testStep4()">Step 4: Get auth instance</button>
  <button onclick="testStep5()">Step 5: Sign in (popup)</button>
  <button onclick="clearLog()">Clear Log</button>
  
  <div id="log"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '287783957820-4ovnfifi2khak78ldomnj7o7pih46nle.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBt1Cj68HX_2xTJgL18YP8pJDnuZ_7OOWY';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    
    let gapiLoaded = false;
    let clientLoaded = false;
    let authInstance = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function testStep1() {
      log('=== STEP 1: Checking if gapi loaded ===');
      
      if (typeof window.gapi === 'undefined') {
        log('❌ ERROR: window.gapi is undefined', 'error');
        log('The Google API script did not load. Check your internet connection.', 'error');
        return false;
      }
      
      log('✅ SUCCESS: window.gapi is loaded', 'success');
      log('gapi object: ' + JSON.stringify(Object.keys(window.gapi)));
      gapiLoaded = true;
      return true;
    }

    async function testStep2() {
      log('=== STEP 2: Loading client:auth2 ===');
      
      if (!gapiLoaded) {
        log('⚠️ WARNING: Run Step 1 first', 'warning');
        await testStep1();
      }
      
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          log('❌ TIMEOUT: gapi.load did not complete in 30 seconds', 'error');
          reject(new Error('Timeout'));
        }, 30000);
        
        log('Loading gapi.load("client:auth2")...');
        
        window.gapi.load('client:auth2', () => {
          clearTimeout(timeout);
          log('✅ SUCCESS: client:auth2 loaded', 'success');
          log('gapi.client available: ' + !!window.gapi.client);
          log('gapi.auth2 available: ' + !!window.gapi.auth2);
          clientLoaded = true;
          resolve(true);
        });
      });
    }

    async function testStep3() {
      log('=== STEP 3: Initializing gapi.client ===');
      
      if (!clientLoaded) {
        log('⚠️ WARNING: Run Step 2 first', 'warning');
        await testStep2();
      }
      
      try {
        log('Calling gapi.client.init with:');
        log('  - apiKey: ' + API_KEY.substring(0, 20) + '...');
        log('  - clientId: ' + CLIENT_ID.substring(0, 30) + '...');
        log('  - scope: ' + SCOPES);
        
        await window.gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: [DISCOVERY_DOC],
          scope: SCOPES
        });
        
        log('✅ SUCCESS: gapi.client initialized', 'success');
        log('gapi.client.calendar available: ' + !!window.gapi.client.calendar);
        return true;
      } catch (error) {
        log('❌ ERROR during initialization: ' + error.message, 'error');
        log('Error details: ' + JSON.stringify(error), 'error');
        
        if (error.message.includes('cookiePolicy')) {
          log('🔧 FIX: Remove cookiePolicy from init config', 'error');
        }
        
        return false;
      }
    }

    async function testStep4() {
      log('=== STEP 4: Getting auth instance ===');
      
      try {
        if (!window.gapi || !window.gapi.auth2) {
          log('⚠️ WARNING: gapi.auth2 not available, running previous steps', 'warning');
          await testStep3();
        }
        
        authInstance = window.gapi.auth2.getAuthInstance();
        
        if (!authInstance) {
          log('❌ ERROR: getAuthInstance() returned null', 'error');
          log('This usually means gapi.client.init() was not called', 'error');
          return false;
        }
        
        log('✅ SUCCESS: Auth instance retrieved', 'success');
        log('isSignedIn: ' + authInstance.isSignedIn.get());
        
        if (authInstance.isSignedIn.get()) {
          const user = authInstance.currentUser.get();
          log('Already signed in as: ' + user.getBasicProfile().getEmail(), 'success');
        }
        
        return true;
      } catch (error) {
        log('❌ ERROR getting auth instance: ' + error.message, 'error');
        return false;
      }
    }

    async function testStep5() {
      log('=== STEP 5: Attempting sign-in ===');
      
      if (!authInstance) {
        log('⚠️ WARNING: Auth instance not available, running previous steps', 'warning');
        const success = await testStep4();
        if (!success) {
          log('❌ Cannot proceed with sign-in', 'error');
          return;
        }
      }
      
      try {
        if (authInstance.isSignedIn.get()) {
          log('✅ Already signed in!', 'success');
          const user = authInstance.currentUser.get();
          log('Email: ' + user.getBasicProfile().getEmail(), 'success');
          return;
        }
        
        log('🚀 Opening sign-in popup...');
        log('⚠️ Check for popup blockers!', 'warning');
        
        const user = await authInstance.signIn({
          prompt: 'consent',
          ux_mode: 'popup'
        });
        
        log('✅ SUCCESS: Signed in!', 'success');
        log('Email: ' + user.getBasicProfile().getEmail(), 'success');
        log('Name: ' + user.getBasicProfile().getName(), 'success');
        
      } catch (error) {
        log('❌ ERROR during sign-in: ' + error.error || error.message, 'error');
        
        if (error.error === 'popup_closed_by_user') {
          log('User closed the popup', 'error');
        } else if (error.error === 'popup_blocked_by_browser') {
          log('🔧 FIX: Allow popups for this site in your browser', 'error');
        } else if (error.error === 'redirect_uri_mismatch') {
          log('🔧 FIX: Check your Authorized redirect URIs in Google Cloud Console', 'error');
          log('Should be: https://accounts.google.com/gsi/postmessage', 'error');
        } else if (error.error === 'access_denied') {
          log('User denied calendar access', 'error');
        } else {
          log('Unknown error: ' + JSON.stringify(error), 'error');
        }
      }
    }

    // Auto-run step 1 on load
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('=== OAuth Debug Tool Loaded ===');
        log('Ready to test. Click buttons in order (Step 1 → Step 5)');
        testStep1();
      }, 500);
    });
  </script>
</body>
</html>







