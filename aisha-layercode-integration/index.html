<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/favicon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aisha - LayerCode Integration</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdn.jsdelivr.net;
      connect-src 'self' blob: ws: wss:;
      frame-src 'self';
      img-src 'self' data: https: blob:;
      style-src 'self' 'unsafe-inline' https:;
      font-src 'self' data: https:;
      media-src 'self' blob: data:;
    ">
    
    <!-- Three.js for 3D avatar -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- React for UI -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        #root {
            height: 100vh;
            width: 100vw;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .avatar-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .chat-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // LayerCode Service Integration
        class LayerCodeService {
            constructor() {
                this.baseUrl = 'https://dash.layercode.com'; // Update with actual LayerCode API
                this.apiKey = null; // Will be set by user
                this.isConnected = false;
            }
            
            async initialize(apiKey) {
                this.apiKey = apiKey;
                // Test connection to LayerCode
                try {
                    // Add your LayerCode API test here
                    console.log('ðŸ”— LayerCode service initialized');
                    this.isConnected = true;
                    return true;
                } catch (error) {
                    console.error('âŒ LayerCode connection failed:', error);
                    return false;
                }
            }
            
            async sendMessage(message) {
                if (!this.isConnected) {
                    throw new Error('LayerCode not connected');
                }
                
                try {
                    // Replace with actual LayerCode API call
                    const response = await fetch(`${this.baseUrl}/api/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            message: message,
                            agent_id: 'qhwfi36h' // Your agent ID
                        })
                    });
                    
                    const data = await response.json();
                    return data.response || 'Sorry, I couldn\'t process that request.';
                } catch (error) {
                    console.error('LayerCode API error:', error);
                    return 'Sorry, I\'m having trouble connecting to LayerCode right now.';
                }
            }
        }
        
        // 3D Avatar Component
        function Avatar({ isSpeaking }) {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const avatarRef = useRef(null);
            
            useEffect(() => {
                if (!mountRef.current) return;
                
                // Scene setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 1, 3);
                
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                mountRef.current.appendChild(renderer.domElement);
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 5, 5);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                // Load avatar model
                const loader = new THREE.GLTFLoader();
                loader.load('/models/wawalipavatar.glb', (gltf) => {
                    const avatar = gltf.scene;
                    avatar.scale.set(1, 1, 1);
                    avatar.position.set(0, 0, 0);
                    scene.add(avatar);
                    avatarRef.current = avatar;
                    
                    // Enable shadows
                    avatar.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                });
                
                // Controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = false;
                controls.enablePan = false;
                controls.maxPolarAngle = Math.PI / 2;
                controls.minPolarAngle = Math.PI / 4;
                
                sceneRef.current = scene;
                rendererRef.current = renderer;
                
                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    
                    // Simple breathing animation
                    if (avatarRef.current) {
                        const time = Date.now() * 0.001;
                        avatarRef.current.position.y = Math.sin(time) * 0.02;
                    }
                    
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                // Handle resize
                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);
                
                return () => {
                    window.removeEventListener('resize', handleResize);
                    if (mountRef.current && renderer.domElement) {
                        mountRef.current.removeChild(renderer.domElement);
                    }
                };
            }, []);
            
            return <div ref={mountRef} className="avatar-container" />;
        }
        
        // Chat Interface Component
        function ChatInterface({ layerCodeService, onMessage }) {
            const [messages, setMessages] = useState([
                {
                    id: 1,
                    type: 'assistant',
                    content: "Hey bestie! I'm Aisha, your AI assistant! I'm now connected to LayerCode. What's up?",
                    timestamp: new Date()
                }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const messagesEndRef = useRef(null);
            
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            useEffect(() => {
                scrollToBottom();
            }, [messages]);
            
            const handleSendMessage = async () => {
                if (!inputMessage.trim() || isLoading) return;
                
                const userMessage = {
                    id: Date.now(),
                    type: 'user',
                    content: inputMessage,
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, userMessage]);
                setInputMessage('');
                setIsLoading(true);
                
                try {
                    const response = await layerCodeService.sendMessage(inputMessage);
                    
                    const assistantMessage = {
                        id: Date.now() + 1,
                        type: 'assistant',
                        content: response,
                        timestamp: new Date()
                    };
                    
                    setMessages(prev => [...prev, assistantMessage]);
                    onMessage(response);
                } catch (error) {
                    console.error('Error sending message:', error);
                    const errorMessage = {
                        id: Date.now() + 1,
                        type: 'assistant',
                        content: "Sorry bestie, I'm having trouble connecting right now. Try again in a sec!",
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };
            
            return (
                <div className="flex flex-col h-full">
                    <div className="flex-1 chat-container p-4 space-y-4">
                        {messages.map((message) => (
                            <div
                                key={message.id}
                                className={`message-bubble flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                            >
                                <div
                                    className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                        message.type === 'user'
                                            ? 'bg-blue-500 text-white'
                                            : 'glass-effect text-white'
                                    }`}
                                >
                                    <p className="text-sm">{message.content}</p>
                                    <p className="text-xs opacity-70 mt-1">
                                        {message.timestamp.toLocaleTimeString()}
                                    </p>
                                </div>
                            </div>
                        ))}
                        
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="glass-effect text-white px-4 py-2 rounded-lg">
                                    <div className="typing-indicator flex space-x-1">
                                        <div className="w-2 h-2 bg-white rounded-full"></div>
                                        <div className="w-2 h-2 bg-white rounded-full"></div>
                                        <div className="w-2 h-2 bg-white rounded-full"></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div ref={messagesEndRef} />
                    </div>
                    
                    <div className="p-4 glass-effect">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Type a message..."
                                className="flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50"
                                disabled={isLoading}
                            />
                            <button
                                onClick={handleSendMessage}
                                disabled={!inputMessage.trim() || isLoading}
                                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-500 text-white rounded-lg transition-colors"
                            >
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        // Main App Component
        function App() {
            const [layerCodeService] = useState(new LayerCodeService());
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            
            const handleMessage = (message) => {
                // Trigger speaking animation
                setIsSpeaking(true);
                setTimeout(() => setIsSpeaking(false), 2000);
            };
            
            const handleConnect = async () => {
                if (!apiKey.trim()) {
                    alert('Please enter your LayerCode API key');
                    return;
                }
                
                const connected = await layerCodeService.initialize(apiKey);
                setIsConnected(connected);
                
                if (connected) {
                    alert('Successfully connected to LayerCode!');
                } else {
                    alert('Failed to connect to LayerCode. Please check your API key.');
                }
            };
            
            return (
                <div className="h-screen flex">
                    {/* Left Panel - Chat */}
                    <div className="w-full lg:w-1/2 flex flex-col">
                        <div className="p-6">
                            <h1 className="text-3xl font-bold text-white mb-2">Aisha</h1>
                            <p className="text-white/80">LayerCode Integration</p>
                        </div>
                        
                        {!isConnected ? (
                            <div className="flex-1 flex items-center justify-center p-6">
                                <div className="glass-effect p-8 rounded-lg max-w-md w-full">
                                    <h2 className="text-xl font-bold text-white mb-4">Connect to LayerCode</h2>
                                    <p className="text-white/80 mb-4">
                                        Enter your LayerCode API key to connect Aisha to your voice agent.
                                    </p>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="LayerCode API Key"
                                        className="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 mb-4"
                                    />
                                    <button
                                        onClick={handleConnect}
                                        className="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
                                    >
                                        Connect
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1">
                                <ChatInterface 
                                    layerCodeService={layerCodeService} 
                                    onMessage={handleMessage}
                                />
                            </div>
                        )}
                    </div>
                    
                    {/* Right Panel - 3D Avatar */}
                    <div className="hidden lg:block lg:w-1/2">
                        <Avatar isSpeaking={isSpeaking} />
                    </div>
                </div>
            );
        }
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
